(function(y){typeof define=="function"&&define.amd?define(y):y()})(function(){"use strict";const l={ADSERVING_URL:"https://adgebra.co.in/afpf/data/loadAdServingData",LOGGING_FLAG:!1},w={DRAG_ICON:"https://demo.adgebra.in/custom/demos/ad/mobile/IRCTC%20/drag.png",CROSS_ICON:"https://demo.adgebra.in/custom/demos/ad/mobile/IRCTC%20/cross.png",ADGEBRA_LOGO:"https://demo.adgebra.in/custom/demos/article_page/Images/32x32_black.jfif"},s={info:(...t)=>{if(l.LOGGING_FLAG){const e=new Date().toISOString();console.log(`[INFO] [${e}]`,...t.map(f))}},warn:(...t)=>{if(l.LOGGING_FLAG){const e=new Date().toISOString();console.warn(`[WARN] [${e}]`,...t.map(f))}},error:(...t)=>{if(l.LOGGING_FLAG){const e=new Date().toISOString();console.error(`[ERROR] [${e}]`,...t.map(f))}},debug:(...t)=>{if(l.LOGGING_FLAG){const e=new Date().toISOString();console.debug(`[DEBUG] [${e}]`,...t.map(f))}},setLoggingStatus:t=>{l.LOGGING_FLAG=t}},f=t=>{if(typeof t=="object")try{return JSON.stringify(t,null,2)}catch{return"[Unable to stringify object]"}return t},I=()=>document.body!==null,x=async(t,e,n)=>{try{if(A(),t!=null&&t.cuboidAds&&e&&n){const o=decodeURIComponent(t.cuboidAds.replace(/\+/g," "));s.info("Decoded Ad",o),_(o,e,n)}}catch(o){s.error(`Error processing Cuboid Ad: ${o}`)}},_=(t,e,n)=>{if(!t)return;let o=n==2?e.cuboidDTop:e.cuboidMTop,r=n==2?e.cuboidDRight:e.cuboidMRight;const a=(M,b={})=>{const h=document.createElement(M);return Object.assign(h,b.attributes||{}),Object.assign(h.style,b.styles||{}),b.events&&Object.entries(b.events).forEach(([k,B])=>h.addEventListener(k,B)),h},c=a("div",{attributes:{id:"adg_cuboid_container"},styles:{position:"fixed",top:o||"80px",right:r||"80px",width:"210px",backgroundColor:"transparent",zIndex:e.zIndex||"100000",cursor:"pointer"}});c.dataset.adgebraContainer="true";const m=a("div",{attributes:{className:"adg_cuboid_controls"},styles:{position:"absolute",top:"0px",right:"0px",display:"flex",gap:"5px"}}),u=a("a",{attributes:{className:"adg_cuboid_drag_element",href:"https://adgebra.co/?utm_source=irctc&utm_medium=web&utm_id=cuboid",target:"_blank"},styles:{width:"15px",height:"15px",cursor:"grab"}}),i=a("img",{attributes:{id:"adg_drag_btn",src:w.DRAG_ICON,alt:"drag"},styles:{width:"15px",height:"15px",cursor:"grab",transition:"all 1s",position:"absolute",top:"0",left:"0"}}),d=a("img",{attributes:{id:"adg_drag_btn",src:w.ADGEBRA_LOGO,alt:"logo"},styles:{width:"15px",height:"15px",cursor:"grab",opacity:"0",transition:"all 1s",position:"absolute",top:"0",left:"0"}});u.append(i,d);const g=a("img",{attributes:{id:"adg_close_btn",src:w.CROSS_ICON},styles:{width:"15px",height:"15px",cursor:"pointer"},events:{click:()=>c.remove()}});m.append(u,g),c.appendChild(m);const p=a("iframe",{styles:{width:"210px",height:"210px",border:"none",overflow:"hidden",scrollbarWidth:"none",padding:"0px",marginTop:"10px",cursor:"pointer"},attributes:{scrolling:"no"}});c.appendChild(p),document.body.appendChild(c),p.contentDocument.open(),p.contentDocument.write(t),p.contentDocument.close(),O(d,i),D(c,u),G()},O=(t,e)=>{let n=!0;setInterval(()=>{n=!n,n?(t.style.opacity="0",e.style.opacity="1"):(e.style.opacity="0",t.style.opacity="1")},3e3)},D=(t,e)=>{let n=!1,o=0,r=0,a=!1;const c=(i,d)=>{n=!0,a=!1;const g=t.getBoundingClientRect();o=i-g.left,r=d-g.top},m=(i,d)=>{if(!n)return;a=!0;const g=Math.max(0,Math.min(window.innerWidth-t.offsetWidth,i-o)),p=Math.max(0,Math.min(window.innerHeight-t.offsetHeight,d-r));t.style.left=`${g}px`,t.style.top=`${p}px`},u=()=>{n=!1};e.addEventListener("mousedown",i=>{c(i.clientX,i.clientY),i.preventDefault()}),document.addEventListener("mousemove",i=>{m(i.clientX,i.clientY)}),document.addEventListener("mouseup",u),e.addEventListener("touchstart",i=>{const d=i.touches[0];c(d.clientX,d.clientY),i.preventDefault()}),document.addEventListener("touchmove",i=>{const d=i.touches[0];m(d.clientX,d.clientY)}),document.addEventListener("touchend",u),e.addEventListener("click",i=>{a&&(i.preventDefault(),i.stopImmediatePropagation())})};let S=window.location.pathname;const G=()=>{s.info("Initializing SPA listener");const t=new MutationObserver(()=>{const e=window.location.pathname;e!==S&&(s.info("SPA navigation detected:",{lastPathname:S,currentPath:e}),S=e,A(),t.disconnect())});t.observe(document.body,{childList:!0,subtree:!0})},A=()=>{const t=document.getElementById("adg_cuboid_container");t&&(s.info("Removing Ad due to SPA navigation change"),t.remove())};async function L(t,e={}){const n=new AbortController,o=setTimeout(()=>n.abort(),1e4);try{const r=await fetch(t,{...e,signal:n.signal});if(clearTimeout(o),!r.ok){const c=await r.text();throw new Error(`Error: ${r.status} - ${r.statusText} | ${c}`)}const a=r.headers.get("Content-Type")||"";if(a.includes("application/json"))return await r.json();if(a.includes("text"))return await r.text();if(a.includes("application/xml")||a.includes("text/xml")){const c=await r.text();return new DOMParser().parseFromString(c,"application/xml")}else return r}catch(r){s.error("API Request Error:",r);return}}async function C(t,e={}){return await L(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}const E=async({partnerId:t,siteURL:e,token:n})=>{try{const o=window.location.href,r={partnerId:t,timestamp:v(),metaKeywords:N(),siteUrl:e,refererURL:o,partnerToken:n},a=await C(l.ADSERVING_URL,r);return s.info("Fetched Data:",a),a}catch(o){return s.error("Error fetching site data:",o),null}},N=()=>{var n;const t=[...document.getElementsByTagName("meta")],e=(n=t.find(o=>o.name.includes("news_keywords")))==null?void 0:n.content;return e||t.filter(o=>o.name.includes("keyword")).map(o=>o.content).filter(Boolean).join(",")},v=()=>{const t=new Date;return parseInt(`${t.getFullYear().toString().slice(-2)}${String(t.getMonth()+1).padStart(2,"0")}${String(t.getDate()).padStart(2,"0")}${String(t.getHours()).padStart(2,"0")}`,10)},P=async t=>{const{partnerId:e,siteURL:n,token:o}=t;if(s.info(`Initializing Ad Serving | PartnerId: ${e}, SiteURL: ${n}, Token: ${o}`),!I()){s.error("Page is not valid. Aborting ad serving.");return}const r=await E(t);r&&T(r)},T=t=>{var o;if(!t)return;if(!t.errorMessage&&!t.siteParametersJson){s.error("Site paramaters Not found");return}let e=$(t);s.info("Site Paramaters: ",e),t.cuboid&&t.cuboid.cuboidAds&&(s.info("Ads siteId: ",t.siteId),s.info("Cuboid response: ",t.cuboid),x(t.cuboid,e,t.deviceId));let n=t.errorMessage||((o=t==null?void 0:t.cuboid)==null?void 0:o.msgCode);n&&s.error("Error message: ",n)},$=t=>{if(t!=null&&t.siteParametersJson)try{return JSON.parse(t.siteParametersJson)}catch(e){s.error("Invalid Site specific JSON string:",e)}};(function(){function t(){if(document.currentScript)return document.currentScript;const n=document.getElementsByTagName("script");return n[n.length-1]}const e=t();if(e){const n=e.getAttribute("partnerId"),o=e.getAttribute("siteURL"),r=e.getAttribute("token");n&&r?P({partnerId:n,siteURL:o,token:r}):s.error("Missing required attributes in script tag.")}})()});
